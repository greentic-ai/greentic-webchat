<!doctype html>
<html lang="en" data-tenant="cisco">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cisco AI Assistant Platform - 3Point Agentic Platform</title>
  <meta name="description" content="Cisco AI Assistant Platform powered by 3Point Agentic Platform with Greentic Inside. Secure, context-aware, enterprise-ready AI collaboration." />
  <script src="../js/tenant-resolver.js"></script>
  <link rel="icon" href="./assets/favicon.ico" sizes="any" />
  <style>
    /* === RESET & BASE === */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    /* === DESIGN TOKENS === */
    :root {
      /* Cisco blues */
      --blue-900: #003a63;
      --blue-800: #004b80;
      --blue-700: #005c9a;
      --blue-500: #008acb;
      --blue-400: #00a0e0;
      --blue-300: #33b6ea;

      /* Surface colors */
      --surface-50: #f8fafc;
      --surface-100: #f1f5f9;
      --surface-200: #e2e8f0;
      --surface-white: #ffffff;

      /* Text */
      --text-strong: #0b1220;
      --text-muted: #475569;
      --text-inverse: #ffffff;

      /* Semantic */
      --accent: var(--blue-400);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;

      /* Layout */
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 2px 8px rgba(2, 18, 46, 0.08);
      --shadow-md: 0 8px 24px rgba(2, 18, 46, 0.12);
      --shadow-lg: 0 16px 48px rgba(2, 18, 46, 0.16);
      --border: 1px solid rgba(2, 18, 46, 0.08);
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;

      /* Transitions */
      --transition-base: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* === TYPOGRAPHY === */
    body {
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
      line-height: 1.6;
      color: var(--text-strong);
      background: var(--surface-50);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100%;
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }

    /* === ACCESSIBILITY === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .sr-only-focusable {
      position: absolute;
      left: -999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    .sr-only-focusable:focus,
    .sr-only-focusable:active {
      position: static;
      width: auto;
      height: auto;
      margin: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--surface-100);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
    }

    /* === HEADER === */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      height: 52px;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(12px);
              backdrop-filter: blur(12px);
      border-bottom: var(--border);
      display: flex;
      align-items: center;
      padding: 0 var(--space-6);
      transition: box-shadow var(--transition-base);
    }

    header.scrolled {
      box-shadow: var(--shadow-sm);
    }

    .header-container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .header-logo svg {
      width: 124px;
      height: auto;
    }

    .header-nav {
      display: flex;
      gap: var(--space-8);
    }

    .header-nav a {
      color: var(--text-strong);
      text-decoration: none;
      font-size: 0.9375rem;
      font-weight: 500;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      transition: all var(--transition-base);
      position: relative;
    }

    .header-nav a:hover {
      color: var(--accent);
      background: var(--surface-100);
    }

    /* === HERO === */
    #hero {
      position: relative;
      background: linear-gradient(135deg, var(--blue-900) 0%, var(--blue-700) 35%, var(--blue-400) 100%);
      color: var(--text-inverse);
      padding: var(--space-12) var(--space-6);
      overflow: hidden;
      text-align: center;
    }

    #hero::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.15), transparent 60%);
      opacity: 0.5;
      mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
      -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
    }

    .hero-container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #hero h1 {
      font-size: clamp(2.5rem, 5vw, 3.75rem);
      margin-bottom: var(--space-4);
      animation: fadeInUp 0.6s ease-out;
    }

    #hero .subheadline {
      font-size: clamp(1.125rem, 2.5vw, 1.5rem);
      opacity: 0.95;
      margin-bottom: var(--space-8);
      font-weight: 400;
      animation: fadeInUp 0.6s ease-out 0.1s backwards;
    }

    .value-chips {
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
      justify-content: center;
      animation: fadeInUp 0.6s ease-out 0.2s backwards;
    }

    .value-chip {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      background: rgba(255, 255, 255, 0.15);
      -webkit-backdrop-filter: blur(8px);
              backdrop-filter: blur(8px);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 0.9375rem;
      font-weight: 500;
      transition: all var(--transition-base);
    }

    .value-chip:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    .value-chip::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 18px;
      background: var(--success);
      border-radius: 50%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
      background-size: 14px;
      background-position: center;
      background-repeat: no-repeat;
      animation: slideInCheck 0.4s ease-out calc(0.3s + var(--chip-index, 0) * 0.1s) backwards;
    }

    /* === QUOTE === */
    #quote {
      background: var(--surface-white);
      padding: var(--space-8) var(--space-6);
      border-left: 4px solid var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .quote-content {
      max-width: 1200px;
      margin: 0 auto;
      font-size: 1.25rem;
      color: var(--text-muted);
      font-style: italic;
      line-height: 1.75;
    }

    .quote-content::before {
      content: '"';
      font-size: 1.5rem;
      color: var(--accent);
      opacity: 0.5;
      line-height: 0;
      margin-right: 4px;
    }

    .quote-content::after {
      content: '"';
      font-size: 1.5rem;
      color: var(--accent);
      opacity: 0.5;
      line-height: 0;
      margin-left: 4px;
    }

    /* === MAIN === */
    main {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: var(--space-12) var(--space-6);
    }

    .bot-shell {
      background: var(--surface-white);
      border-radius: var(--radius-lg);
      border: var(--border);
      box-shadow: var(--shadow-md);
      margin-top: var(--space-6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .bot-shell-header {
      background: #f6f7fb;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }

    .bot-shell-title {
      font-size: 1rem;
      font-weight: 600;
      color: #0b1220;
      letter-spacing: 0.05em;
    }

    .bot-shell-status-container {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }

    .bot-shell-main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 1.5rem 1.25rem 2rem;
    }

    .bot-chat-panel {
      width: 100%;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      border-radius: 1.25rem;
      border: 1px solid rgba(15, 23, 42, 0.06);
      overflow: hidden;
      background: #fff;
      box-shadow: 0 15px 40px rgba(2, 18, 46, 0.12);
    }

    #webchat {
      flex: 1;
      min-height: 480px;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.95);
      font-weight: 600;
      color: var(--text-strong);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
    }

    .connection-dot {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: var(--status-warn, #f59e0b);
      display: inline-block;
    }

    .status-bar.ok .connection-dot,
    .connection-dot.ok {
      background: var(--status-ok, #22c55e);
    }

    .status-bar.warn .connection-dot,
    .connection-dot.warn {
      background: var(--status-warn, #f59e0b);
    }

    .status-bar.err .connection-dot,
    .connection-dot.err {
      background: var(--status-err, #ef4444);
    }

    .error-state {
      padding: var(--space-6);
      background: rgba(239, 68, 68, 0.1);
      color: var(--text-strong);
      border-top: 1px solid rgba(239, 68, 68, 0.3);
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .error-state.hidden {
      display: none;
    }

    .debug-overlay {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: rgba(2, 6, 23, 0.9);
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.75rem;
      z-index: 999;
      max-width: 240px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.4);
      line-height: 1.3;
    }

    .debug-overlay.hidden {
      display: none;
    }

    /* === FOOTER === */
    #brand-footer {
      background: var(--blue-900);
      color: var(--text-inverse);
      padding: var(--space-8) var(--space-6);
      text-align: center;
      margin-top: auto;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
    }

    .footer-text {
      font-size: 0.9375rem;
      margin-bottom: var(--space-4);
      opacity: 0.9;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: var(--space-8);
      flex-wrap: wrap;
    }

    .footer-links a {
      color: var(--text-inverse);
      text-decoration: none;
      opacity: 0.85;
      transition: opacity var(--transition-base);
      font-weight: 500;
    }

    .footer-links a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    /* === ANIMATIONS === */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideInCheck {
      from {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      to {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      header {
        height: auto;
        min-height: 52px;
        padding: var(--space-4);
      }

      .header-container {
        flex-direction: column;
        gap: var(--space-4);
      }

      .header-nav {
        gap: var(--space-4);
        font-size: 0.875rem;
      }

      #hero {
        padding: var(--space-12) var(--space-4);
      }

      #hero::before {
        width: 100%;
        opacity: 0.1;
      }

      .value-chips {
        gap: var(--space-3);
      }

      .value-chip {
        padding: var(--space-2) var(--space-4);
        font-size: 0.875rem;
      }

      #quote {
        padding: var(--space-6) var(--space-4);
      }

      .quote-content {
        font-size: 1rem;
      }

      main {
        padding: var(--space-8) var(--space-4);
      }

      .chat-card {
        min-height: 500px;
      }

      .chat-card-body {
        min-height: 400px;
      }
    }
</style>
</head>
<body>
  <a href="#webchat" class="sr-only-focusable">Skip to chat</a>
  <div id="skin-error" aria-live="polite"></div>
  <!-- HEADER -->
  <header id="main-header">
    <div class="header-container">
      <div class="header-logo">
        <!-- Inline Cisco logo (source: ./assets/cisco-logo.svg) -->
        <svg viewBox="0 0 40 40" role="img" aria-label="Cisco logo" width="124" height="40" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
          <path fill="#00678c" d="M11.312 23.474h1.75v6.975h-1.75zm15.895 2a3.01 3.01 0 00-1.473-.37c-1.135 0-1.92.792-1.92 1.86 0 1.035.753 1.862 1.92 1.862.825 0 1.4-.327 1.473-.37v1.87c-.225.065-.815.25-1.6.25-1.975 0-3.703-1.365-3.703-3.612 0-2.078 1.568-3.61 3.7-3.61.825 0 1.435.2 1.6.25zm-18.302 0c-.075-.043-.633-.37-1.475-.37-1.135 0-1.918.792-1.918 1.86 0 1.035.75 1.862 1.92 1.862.825 0 1.4-.327 1.473-.37v1.87c-.218.065-.818.25-1.6.25-1.97 0-3.705-1.365-3.705-3.612 0-2.078 1.567-3.61 3.705-3.61.825 0 1.43.2 1.6.25zm27.492 1.482c0 2-1.535 3.61-3.67 3.61-2.138 0-3.675-1.612-3.675-3.61 0-1.99 1.537-3.61 3.675-3.61 2.135.008 3.67 1.62 3.67 3.61zm-3.67-1.83a1.8 1.8 0 00-1.818 1.83c0 1.01.775 1.838 1.818 1.838a1.8 1.8 0 001.815-1.838 1.8 1.8 0 00-1.815-1.83zm-13.01-.062a5.967 5.967 0 00-1.367-.218c-.703 0-1.088.233-1.088.57 0 .425.513.57.808.665l.48.153c1.137.362 1.657 1.15 1.657 2 0 1.75-1.537 2.34-2.88 2.34a9.807 9.807 0 01-1.897-.193v-1.602c.152.04.89.255 1.657.255.873 0 1.273-.255 1.273-.65 0-.35-.345-.553-.785-.698-.105-.032-.265-.087-.375-.12-.975-.312-1.793-.882-1.793-2.037 0-1.3.975-2.183 2.593-2.183.855 0 1.655.208 1.71.225v1.493zM1.742 15.98a.867.867 0 00-.87-.867.867.867 0 00-.872.867v1.828a.875.875 0 00.872.875.875.875 0 00.87-.875v-1.825zm4.785-2.4a.875.875 0 00-.872-.875.875.875 0 00-.87.875v4.23a.875.875 0 00.87.875.875.875 0 00.875-.875v-4.23zm4.775-3.287a.867.867 0 00-.87-.87.875.875 0 00-.872.867v9.258a.875.875 0 00.872.875.875.875 0 00.873-.875v-9.255zm4.785 3.287a.875.875 0 00-.872-.875.875.875 0 00-.87.875v4.23a.875.875 0 00.87.875.875.875 0 00.872-.875zm4.785 2.4a.869.869 0 10-1.737 0v1.83a.875.875 0 00.875.875.867.867 0 00.862-.875zm4.782-2.4a.875.875 0 00-.872-.875.875.875 0 00-.87.875v4.23a.875.875 0 00.87.875.875.875 0 00.875-.875zm4.785-3.287a.867.867 0 00-.872-.87.875.875 0 00-.873.867v9.258a.875.875 0 00.873.875.875.875 0 00.872-.875zm4.783 3.287a.875.875 0 00-1.75 0v4.23a.875.875 0 001.75 0zm4.777 2.4a.867.867 0 00-.872-.867.875.875 0 00-.873.867v1.83a.875.875 0 00.873.875.875.875 0 00.872-.875z"/>
        </svg>
        <noscript>
          <img src="./assets/cisco-logo@2x.png" alt="Cisco" width="124" height="40" decoding="async" loading="eager" />
        </noscript>
      </div>
      <nav class="header-nav" role="navigation" aria-label="Main navigation">
        <a href="#overview">Overview</a>
        <a href="#use-cases">Use Cases</a>
        <a href="#security">Security</a>
        <a href="#docs">Docs</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" role="banner">
    <div class="hero-container">
      <h1>Cisco AI Assistant Platform</h1>
      <p class="subheadline">Powered by 3Point Agentic Platform with Greentic Inside</p>
      <div class="value-chips" role="list">
        <div class="value-chip" role="listitem" style="--chip-index: 0;">Secure</div>
        <div class="value-chip" role="listitem" style="--chip-index: 1;">Context-Aware</div>
        <div class="value-chip" role="listitem" style="--chip-index: 2;">Enterprise-Ready</div>
      </div>
    </div>
  </section>

  <!-- QUOTE -->
  <section id="quote" role="complementary" aria-label="Enterprise quote">
    <blockquote class="quote-content">
      Cisco is advancing secure, AI-driven collaboration. This assistant demonstrates how the 3Point Agentic Platform with Greentic Inside delivers trusted automation, data integrity, and operational excellence across the enterprise.
    </blockquote>
  </section>

  <!-- MAIN CHAT -->
  <main role="main">
    <section class="bot-shell" aria-label="Cisco AI Assistant chat">
      <header class="bot-shell-header">
        <div class="bot-shell-title">AI Cisco Assistant</div>
        <div class="bot-shell-status-container">
          <div id="statusbar" class="status-bar warn" role="status" aria-live="polite">
            <span class="connection-dot status-dot warn" id="status-dot" aria-hidden="true"></span>
            <span id="status-text">Connecting…</span>
          </div>
        </div>
      </header>
      <div class="bot-shell-main">
        <div class="bot-chat-panel">
          <div id="webchat" role="region" aria-label="Cisco AI Assistant" class="bot-chat"></div>
          <div id="error-state" class="error-state hidden" role="alert">
            <p class="error-title" id="error-title"></p>
            <p class="error-message" id="error-message"></p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer id="brand-footer" role="contentinfo">
    <div class="footer-content">
      <p class="footer-text">3Point Agentic Platform with Greentic Inside</p>
      <nav class="footer-links" aria-label="Footer navigation">
        <a href="https://3point.ai" target="_blank" rel="noopener noreferrer">3Point Agentic Platform</a>
        <a href="https://greentic.ai" target="_blank" rel="noopener noreferrer">Greentic</a>
      </nav>
    </div>
  </footer>

  <!-- BotFramework Web Chat CDN -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js" crossorigin="anonymous"></script>

  <script>
    (function () {
      'use strict';

      const DEFAULT_TOKEN_URL = 'https://demo.greentic.ai/token?tenant=cisco';
      const statusBar = document.getElementById('statusbar');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const webchatContainer = document.getElementById('webchat');
      const errorState = document.getElementById('error-state');
      const errorTitle = document.getElementById('error-title');
      const errorMessage = document.getElementById('error-message');
      const debugEnabled = new URLSearchParams(window.location.search).get('debug') === '1';
      const debugOverlay = document.createElement('div');
      debugOverlay.id = 'debug-overlay';
      debugOverlay.classList.add('debug-overlay', 'hidden');
      document.body.appendChild(debugOverlay);

      const styleOptions = {
        hideUploadButton: true,
        bubbleBorderRadius: 12,
        bubbleBackground: '#FFFFFF',
        bubbleFromUserBackground: '#00a0e0',
        bubbleFromUserBorderRadius: 12,
        bubbleTextColor: '#0b1220',
        bubbleFromUserTextColor: '#FFFFFF',
        botAvatarInitials: 'AI',
        userAvatarInitials: 'You',
        accent: '#00a0e0',
        subtle: '#475569',
        cardEmphasisBackgroundColor: '#f1f5f9',
        paddingRegular: 12,
        primaryFont: 'ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
      };

      let tokenFetchState = 'idle';
      let connectionStatus = 'uninitialized';
      let resolvedTokenUrl = '';
      let resolvedDomain = '';
      let resolvedTenant = window.__TENANT__ || 'cisco';
      let resolvedSkinTheme = 'cisco';

      function updateDebugPanel() {
        if (!debugEnabled) {
          debugOverlay.classList.add('hidden');
          return;
        }
        debugOverlay.classList.remove('hidden');
        debugOverlay.innerHTML = `
          <strong>debug</strong>
          <div>tokenFetchState: ${tokenFetchState}</div>
          <div>connectionStatus: ${connectionStatus}</div>
          <div>tokenUrl: ${resolvedTokenUrl || 'n/a'}</div>
          <div>domain: ${resolvedDomain || 'n/a'}</div>
          <div>tenant: ${resolvedTenant}</div>
          <div>skin: ${resolvedSkinTheme}</div>
        `;
      }

      function setStatus(kind, text) {
        if (!statusBar || !statusText || !statusDot) {
          return;
        }
        statusBar.classList.remove('ok', 'warn', 'err');
        statusDot.classList.remove('ok', 'warn', 'err');
        statusBar.classList.add(kind);
        statusDot.classList.add(kind);
        statusText.textContent = text;
        updateDebugPanel();
      }

      function showError(title, message) {
        if (!errorState || !errorTitle || !errorMessage) {
          return;
        }
        errorTitle.textContent = title;
        errorMessage.textContent = message;
        errorState.classList.remove('hidden');
      }

      function applyBrand(skin) {
        if (!skin || !skin.brand) {
          return;
        }
        const brand = skin.brand;
        const root = document.documentElement;
        if (brand.primary) {
          root.style.setProperty('--blue-900', brand.primary);
          root.style.setProperty('--blue-700', brand.primary);
        }
        if (brand.accent) {
          root.style.setProperty('--blue-500', brand.accent);
          root.style.setProperty('--blue-400', brand.accent);
        }
        if (brand.text) {
          root.style.setProperty('--text-strong', brand.text);
        }
      }

      function applyStatusColors(brandColors) {
        const root = document.documentElement;
        if (!brandColors) {
          root.style.setProperty('--status-ok', '#22c55e');
          root.style.setProperty('--status-warn', '#f59e0b');
          root.style.setProperty('--status-err', '#ef4444');
          return;
        }
        if (brandColors.ok) {
          root.style.setProperty('--status-ok', brandColors.ok);
        }
        if (brandColors.warn) {
          root.style.setProperty('--status-warn', brandColors.warn);
        }
        if (brandColors.err) {
          root.style.setProperty('--status-err', brandColors.err);
        }
      }

      function normalizeConnectionStatus(value) {
        const conn = window.WebChat?.ConnectionStatus;
        if (!conn || typeof value !== 'number') {
          return null;
        }
        if (value === conn.Online) {
          return 'connected';
        }
        if (value === conn.Connecting || value === conn.Uninitialized) {
          return 'connecting';
        }
        if ('Reconnecting' in conn && value === conn.Reconnecting) {
          return 'reconnecting';
        }
        if (value === conn.FailedToConnect || value === conn.Ended) {
          return 'failedToConnect';
        }
        if (value === conn.ExpiredToken) {
          return 'expiredToken';
        }
        return null;
      }

      function handleConnectionStatus(status) {
        const normalized = normalizeConnectionStatus(status);
        if (!normalized) {
          return;
        }
        connectionStatus = normalized;
        updateDebugPanel();
        if (normalized === 'connected') {
          setStatus('ok', 'Connected');
        } else if (normalized === 'failedToConnect' || normalized === 'expiredToken' || normalized === 'reconnecting') {
          setStatus('err', 'Disconnected. Reconnecting…');
        } else {
          setStatus('warn', 'Connecting…');
        }
      }

      function getDirectLineOverride() {
        const params = new URLSearchParams(window.location.search);
        const value = params.get('directline');
        if (!value) {
          return null;
        }
        return value.trim();
      }

      function normalizeUrl(input) {
        const trimmed = input.trim();
        if (/^https?:\/\//i.test(trimmed)) {
          return trimmed;
        }
        return `https://${trimmed}`;
      }

      function looksLikeDirectLineDomain(url) {
        const cleanPath = (url.pathname || '/').replace(/\/+$/, '') || '/';
        return cleanPath === '/' || /\/v3\/directline$/i.test(cleanPath);
      }

      function buildDirectLineDomain(url) {
        const cleanPath = (url.pathname || '/').replace(/\/+$/, '');
        if (!cleanPath || cleanPath === '/') {
          return `${url.origin}/v3/directline`;
        }
        if (/\/v3\/directline$/i.test(cleanPath)) {
          return `${url.origin}${cleanPath}`;
        }
        return `${url.origin}${cleanPath}`;
      }

      async function requestToken(url) {
        resolvedTokenUrl = url;
        updateDebugPanel();
        const response = await fetch(url, {
          method: 'POST',
          headers: { Accept: 'application/json' },
          credentials: 'omit'
        });
        if (!response.ok) {
          throw new Error(`Direct Line token request failed (${response.status})`);
        }
        const payload = await response.json();
        if (!payload || typeof payload.token !== 'string') {
          throw new Error('Token endpoint did not return a token.');
        }
        tokenFetchState = 'ok';
        updateDebugPanel();
        return payload.token;
      }

      async function resolveDirectLineConfig(baseTokenUrl) {
        tokenFetchState = 'loading';
        updateDebugPanel();
        const override = getDirectLineOverride();
        if (!override) {
          const token = await requestToken(baseTokenUrl);
          return { token };
        }
        const normalized = normalizeUrl(override);
        try {
          const token = await requestToken(normalized);
          return { token };
        } catch (error) {
          let parsedUrl;
          try {
            parsedUrl = new URL(normalized);
          } catch {
            throw error;
          }
          if (!looksLikeDirectLineDomain(parsedUrl)) {
            throw error;
          }
          const token = await requestToken(baseTokenUrl);
          resolvedDomain = buildDirectLineDomain(parsedUrl);
          updateDebugPanel();
          return { token, domain: resolvedDomain };
        }
      }

      async function getSkinContext() {
        if (typeof window.__loadSkin__ === 'function') {
          try {
            const skin = await window.__loadSkin__();
            resolvedTenant = skin?.tenant || resolvedTenant;
            resolvedSkinTheme = skin?.theme || resolvedSkinTheme;
            return skin;
          } catch {
            return null;
          }
        }
        return null;
      }

      async function init() {
        try {
          const skin = await getSkinContext();
          applyBrand(skin);
          applyStatusColors(skin?.statusBar?.brand);
          setStatus('warn', 'Connecting…');
          const tokenUrl = skin?.directLine?.tokenUrl || DEFAULT_TOKEN_URL;
          const directLineConfig = await resolveDirectLineConfig(tokenUrl);
          if (!window.WebChat || !webchatContainer) {
            throw new Error('WebChat root or library missing');
          }
          const directLine = window.WebChat.createDirectLine({
            token: directLineConfig.token,
            webSocket: true,
            ...(directLineConfig.domain ? { domain: directLineConfig.domain } : {})
          });
          directLine.connectionStatus$?.subscribe(handleConnectionStatus);
          window.WebChat.renderWebChat(
            {
              directLine,
              styleOptions
            },
            webchatContainer
          );
        } catch (error) {
          tokenFetchState = 'error';
          updateDebugPanel();
          setStatus('err', 'Unable to fetch a Direct Line token. Please try again later.');
          showError('Unable to connect', 'We could not reach the Direct Line token service. Please try again later.');
          console.error('[cisco-demo] Web Chat initialization failed', error);
        }
      }

      function whenReady(callback) {
        if (window.WebChat) {
          callback();
          return;
        }
        const script = document.querySelector('script[src*="botframework-webchat"]');
        if (script) {
          script.addEventListener('load', callback);
          script.addEventListener('error', () => {
            console.error('Unable to load BotFramework Web Chat script.');
          });
        } else {
          window.addEventListener('load', callback);
        }
      }

      updateDebugPanel();
      whenReady(init);
    })();
  </script>
</body>
</html>
